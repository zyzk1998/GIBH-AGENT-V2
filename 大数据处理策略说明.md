# Cell Ranger 大数据处理策略说明

## 📊 当前实现状态

### ✅ 已实现的处理策略

1. **依赖 Cell Ranger 自身的大数据处理能力**
   - Cell Ranger 本身是 10x Genomics 官方工具，已经针对大数据进行了优化
   - 使用 `subprocess` 调用，Cell Ranger 自己处理 FASTQ 文件的读取和流式处理
   - **智能体不直接处理二进制数据**，只传递文件路径

2. **资源控制参数**
   ```python
   # 通过配置控制资源使用
   localcores: 8  # CPU 核心数
   localmem: 32   # 内存（GB）
   create_bam: false  # 不创建 BAM 文件，节省空间和时间
   ```

3. **文件路径传递机制**
   - 智能体只处理文件路径（字符串），不加载二进制数据到内存
   - 所有文件操作都通过文件系统路径进行

### ⚠️ 当前限制

1. **没有实现任务分发到 HPC**
   - 虽然代码中有 `TaskDispatcher` 类，支持 Slurm/SSH 提交
   - 但 `RNAAgent.execute_workflow()` 中**没有实际使用** TaskDispatcher
   - Cell Ranger 目前是**本地同步执行**，会阻塞主进程

2. **没有流式处理机制**
   - 对于 TB 级的 FASTQ 文件，Cell Ranger 会一次性处理
   - 没有实现分块处理或增量处理

3. **内存管理**
   - 依赖 Cell Ranger 自身的内存管理
   - 没有实现内存监控或限制机制

## 🔧 当前实现代码

```python
# gibh_agent/tools/cellranger_tool.py
def run_count(...):
    # 构建命令
    cmd = [
        self.cellranger_bin,
        "count",
        "--id", sample_id,
        "--create-bam", "true" if create_bam else "false",
        "--transcriptome", reference,
        "--fastqs", fastq_dir,
        "--localcores", str(localcores),
        "--localmem", str(localmem)
    ]
    
    # 同步执行（会阻塞）
    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        check=False
    )
```

## 💡 改进建议

### 1. 集成 TaskDispatcher（推荐）

```python
# 在 RNAAgent.execute_workflow() 中
if file_type == "fastq":
    # 生成 Cell Ranger 脚本
    script = self.cellranger_tool.generate_count_script(...)
    
    # 提交到 HPC（如果配置了）
    if self.dispatcher and self.dispatcher.dispatcher_type != "local":
        job = await self.dispatcher.submit_script(
            script_content=script,
            script_name=f"{sample_id}_cellranger.sh"
        )
        # 等待任务完成
        while True:
            status = await self.dispatcher.check_status(job["job_id"])
            if status["status"] == "completed":
                break
            await asyncio.sleep(60)  # 每分钟检查一次
    else:
        # 本地执行
        cellranger_result = self.scanpy_tool.run_cellranger(...)
```

### 2. 添加进度监控

```python
# 监控 Cell Ranger 输出
process = subprocess.Popen(
    cmd,
    stdout=subprocess.PIPE,
    stderr=subprocess.STDOUT,
    universal_newlines=True,
    bufsize=1
)

# 实时读取输出
for line in process.stdout:
    if "Processing" in line or "%" in line:
        yield f"Cell Ranger 进度: {line}"
```

### 3. 支持大文件检查

```python
def check_fastq_size(self, fastq_dir: str) -> Dict[str, Any]:
    """检查 FASTQ 文件大小，决定是否需要 HPC"""
    total_size = 0
    for file in Path(fastq_dir).glob("*.fastq*"):
        total_size += file.stat().st_size
    
    size_gb = total_size / (1024**3)
    
    return {
        "total_size_gb": size_gb,
        "recommend_hpc": size_gb > 100,  # 超过 100GB 推荐使用 HPC
        "estimated_time_hours": size_gb * 0.1  # 粗略估算
    }
```

## 📋 总结

**当前策略：**
- ✅ 依赖 Cell Ranger 自身的大数据处理能力
- ✅ 通过参数控制资源使用
- ✅ 只处理文件路径，不加载二进制数据
- ⚠️ 本地同步执行，可能阻塞
- ⚠️ 没有任务分发机制

**推荐改进：**
1. 集成 TaskDispatcher，支持提交到 HPC 集群
2. 添加文件大小检查，自动决定执行方式
3. 实现异步任务监控和进度报告
4. 添加内存和磁盘空间检查

