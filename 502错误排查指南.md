# 502 Bad Gateway é”™è¯¯æ’æŸ¥æŒ‡å—

## ğŸ” é—®é¢˜ç°è±¡

è®¿é—® `http://localhost:8018` æ—¶å‡ºç°ï¼š
- **502 Bad Gateway**
- **nginx/1.29.4**

## ğŸ“‹ æ’æŸ¥æ­¥éª¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
sudo docker compose ps
```

**é¢„æœŸç»“æœï¼š**
- `gibh_v2_gateway` (nginx) - `Up`
- `gibh_v2_api` (api-server) - `Up`
- `gibh_v2_worker` (worker) - `Up`
- `gibh_v2_redis` (redis) - `Up`

**å¦‚æœçœ‹åˆ°å®¹å™¨ä¸æ–­é‡å¯ï¼š**
- è¯´æ˜å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦æŸ¥çœ‹æ—¥å¿—

### 2. æŸ¥çœ‹ API æœåŠ¡å™¨æ—¥å¿—

```bash
sudo docker compose logs api-server --tail 50
```

**å¸¸è§é”™è¯¯ï¼š**

#### âŒ é”™è¯¯ 1: `ModuleNotFoundError: No module named 'paramiko'`
```
File "/app/gibh_agent/core/dispatcher.py", line 11, in <module>
    import paramiko
ModuleNotFoundError: No module named 'paramiko'
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. ç¡®è®¤ requirements.txt åŒ…å« paramiko
grep paramiko requirements.txt

# 2. é‡æ–°æ„å»ºé•œåƒ
sudo ./docker-rebuild.sh

# 3. å¯åŠ¨æœåŠ¡
sudo docker compose up -d
```

#### âŒ é”™è¯¯ 2: `Worker failed to boot`
```
[ERROR] Worker (pid:7) exited with code 3
[ERROR] Reason: Worker failed to boot.
```

**å¯èƒ½åŸå› ï¼š**
- ä¾èµ–ç¼ºå¤±
- é…ç½®æ–‡ä»¶é”™è¯¯
- ç¯å¢ƒå˜é‡æœªè®¾ç½®

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯
sudo docker compose logs api-server

# æ£€æŸ¥ç¯å¢ƒå˜é‡
sudo docker compose exec api-server env | grep SILICONFLOW
```

#### âŒ é”™è¯¯ 3: `GIBH-AGENT åˆå§‹åŒ–å¤±è´¥`
```
âŒ GIBH-AGENT åˆå§‹åŒ–å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ `gibh_agent/config/settings.yaml`
- ç¡®è®¤ `SILICONFLOW_API_KEY` ç¯å¢ƒå˜é‡å·²è®¾ç½®
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### 3. æ£€æŸ¥ç½‘ç»œè¿æ¥

```bash
# ä» NGINX å®¹å™¨æµ‹è¯• API æœåŠ¡å™¨
sudo docker compose exec nginx ping -c 2 api-server

# ä» API æœåŠ¡å™¨æµ‹è¯• Redis
sudo docker compose exec api-server ping -c 2 redis
```

### 4. æµ‹è¯• API æœåŠ¡å™¨ç›´æ¥è®¿é—®

```bash
# è¿›å…¥ API æœåŠ¡å™¨å®¹å™¨
sudo docker compose exec api-server bash

# æµ‹è¯•å†…éƒ¨ç«¯å£
curl http://localhost:8000/api/docs
```

å¦‚æœå†…éƒ¨å¯ä»¥è®¿é—®ï¼Œè¯´æ˜é—®é¢˜åœ¨ NGINX é…ç½®ã€‚

### 5. æ£€æŸ¥ NGINX é…ç½®

```bash
# æŸ¥çœ‹ NGINX é…ç½®
cat services/nginx/conf.d/default.conf

# æ£€æŸ¥ NGINX æ—¥å¿—
sudo docker compose logs nginx --tail 20
```

**å¸¸è§ NGINX é”™è¯¯ï¼š**
```
connect() failed (113: Host is unreachable) while connecting to upstream
```
- è¯´æ˜ NGINX æ— æ³•è¿æ¥åˆ° `api-server:8000`
- æ£€æŸ¥å®¹å™¨ç½‘ç»œæ˜¯å¦æ­£å¸¸

## ğŸ”§ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é‡æ–°æ„å»ºå¹¶å¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
# 1. åœæ­¢æ‰€æœ‰å®¹å™¨
sudo docker compose down

# 2. é‡æ–°æ„å»ºï¼ˆåŒ…å«æœ€æ–°ä¾èµ–ï¼‰
sudo docker compose build --no-cache

# 3. å¯åŠ¨æœåŠ¡
sudo docker compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
sudo docker compose logs -f api-server
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨è¯Šæ–­è„šæœ¬

```bash
sudo ./diagnose-502.sh
```

### æ–¹æ¡ˆ 3: ä¸´æ—¶ä½¿ç”¨åŸå§‹æ–¹å¼ï¼ˆç»•è¿‡ Dockerï¼‰

å¦‚æœ Docker é—®é¢˜æ— æ³•å¿«é€Ÿè§£å†³ï¼Œå¯ä»¥ä¸´æ—¶ä½¿ç”¨åŸå§‹æ–¹å¼ï¼š

```bash
# 1. åœæ­¢ Docker å®¹å™¨
sudo docker compose down

# 2. ç›´æ¥è¿è¡Œ server.py
python server.py
# æˆ–
uvicorn server:app --host 0.0.0.0 --port 8018
```

ç„¶åè®¿é—® `http://localhost:8018`ï¼ˆä¼šçœ‹åˆ°ç®€å•çš„æµ‹è¯•ç•Œé¢ï¼Œä¸æ˜¯ NGINX çš„ç²¾ç¾ç•Œé¢ï¼‰

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œæ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

1. **å®¹å™¨çŠ¶æ€æ­£å¸¸ï¼š**
   ```bash
   sudo docker compose ps
   ```
   æ‰€æœ‰å®¹å™¨åº”è¯¥æ˜¯ `Up` çŠ¶æ€

2. **API æœåŠ¡å™¨å“åº”ï¼š**
   ```bash
   curl http://localhost:8018/api/docs
   ```
   åº”è¯¥è¿”å› HTML å†…å®¹ï¼ˆSwagger UIï¼‰

3. **å‰ç«¯é¡µé¢æ­£å¸¸ï¼š**
   è®¿é—® `http://localhost:8018`ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   - âœ… ç²¾ç¾çš„å‰ç«¯ç•Œé¢ï¼ˆä¸æ˜¯ 502 é”™è¯¯ï¼‰
   - âœ… å¯ä»¥å‘é€æ¶ˆæ¯
   - âœ… å¯ä»¥ä¸Šä¼ æ–‡ä»¶

## ğŸ“ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ sudoï¼Ÿ
A: Docker é»˜è®¤éœ€è¦ root æƒé™ã€‚å¯ä»¥å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ï¼š
```bash
sudo usermod -aG docker $USER
# ç„¶åé‡æ–°ç™»å½•
```

### Q2: æ„å»ºé•œåƒå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ
A: å·²é…ç½®å›½å†…é•œåƒæºï¼ˆé˜¿é‡Œäº‘ + æ¸…åå¤§å­¦ï¼‰ï¼Œå¦‚æœè¿˜æ˜¯æ…¢ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ä½¿ç”¨ `docker compose build --no-cache` å¼ºåˆ¶é‡æ–°æ„å»º

### Q3: ä¿®æ”¹ä»£ç åéœ€è¦é‡æ–°æ„å»ºå—ï¼Ÿ
A: å¦‚æœä½¿ç”¨å·æŒ‚è½½ï¼ˆ`volumes: - .:/app`ï¼‰ï¼Œä»£ç ä¿®æ”¹ä¼šç«‹å³ç”Ÿæ•ˆï¼Œä½†ï¼š
- æ–°å¢ä¾èµ–éœ€è¦é‡æ–°æ„å»º
- ä¿®æ”¹ Dockerfile éœ€è¦é‡æ–°æ„å»º

### Q4: å¦‚ä½•æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼Ÿ
```bash
# æ‰€æœ‰æœåŠ¡
sudo docker compose logs -f

# ç‰¹å®šæœåŠ¡
sudo docker compose logs -f api-server
sudo docker compose logs -f worker
```

## ğŸ†˜ å¦‚æœè¿˜æ˜¯æ— æ³•è§£å†³

1. **æ”¶é›†å®Œæ•´æ—¥å¿—ï¼š**
   ```bash
   sudo docker compose logs > docker-logs.txt 2>&1
   ```

2. **æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼š**
   ```bash
   free -h
   df -h
   ```

3. **æ£€æŸ¥ Docker çŠ¶æ€ï¼š**
   ```bash
   sudo systemctl status docker
   ```

4. **æŸ¥çœ‹è¯¦ç»†é”™è¯¯ï¼š**
   ```bash
   sudo docker compose exec api-server python -c "from gibh_agent import create_agent; agent = create_agent('gibh_agent/config/settings.yaml')"
   ```

