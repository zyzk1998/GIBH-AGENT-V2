# 多智能体协同系统架构优化建议

## 🎯 当前架构分析

### ✅ 已实现的多智能体架构

```
GIBHAgent (主入口)
├── RouterAgent (路由智能体)
│   └── 职责：识别组学类型，路由到对应专家
│
└── Domain Agents (领域智能体)
    ├── RNAAgent (转录组专家) ✅ 已完整实现
    ├── DNAAgent (基因组专家) ⚠️ 占位符
    ├── EpigenomicsAgent ⚠️ 占位符
    ├── MetabolomicsAgent ⚠️ 占位符
    ├── ProteomicsAgent ⚠️ 占位符
    └── ...
```

### ⚠️ 当前问题

1. **RNAAgent 提示词过于复杂**
   - 包含了太多工具说明
   - 工作流规则冗长
   - 可能混淆大模型处理

2. **职责边界不清**
   - RouterAgent 和 RNAAgent 的职责有重叠
   - 提示词中混合了路由逻辑和分析逻辑

---

## 💡 优化方案

### 方案 1: 简化提示词，职责分离（推荐）

#### RouterAgent 提示词（简化）

```python
# 只负责路由，不涉及具体分析
router_prompt = """
你是路由智能体，只负责识别用户意图并路由到对应的专家智能体。

【你的职责】
1. 识别组学类型（转录组、基因组、表观遗传组等）
2. 识别用户意图（分析、可视化、解释）
3. 返回路由决策（JSON格式）

【不要做】
- 不要执行具体分析
- 不要推荐参数
- 不要解释工具用法

【输出格式】
返回 JSON：
{
    "modality": "transcriptomics",
    "routing": "rna_agent",
    "confidence": 0.95
}
"""
```

#### RNAAgent 提示词（简化）

```python
# 只负责转录组分析，不涉及路由
rna_prompt = """
你是转录组分析专家。

【你的职责】
执行单细胞转录组分析流程。

【工作流】
1. 检查数据（inspect_file）
2. 推荐参数
3. 执行分析

【可用工具】
- inspect_file: 检查数据
- run_cellranger: 运行 Cell Ranger
- convert_cellranger_to_h5ad: 转换格式
- local_qc, local_normalize, ...: 分析步骤

【输出格式】
使用 <think> 标签包裹思考过程。
"""
```

### 方案 2: 分层提示词系统

```
Level 1: RouterAgent
  └── 简单提示词：只做路由决策

Level 2: Domain Agents
  └── 专业提示词：只关注本领域分析

Level 3: Tools
  └── 工具说明：通过代码注释和文档，不在提示词中
```

### 方案 3: 动态提示词注入

```python
# 根据上下文动态构建提示词
def get_rna_prompt(context):
    base_prompt = "你是转录组分析专家。"
    
    # 只注入必要的上下文
    if context.get("has_fastq"):
        base_prompt += "\n用户提供了 FASTQ 文件。"
    
    if context.get("has_h5ad"):
        base_prompt += "\n用户提供了 .h5ad 文件。"
    
    return base_prompt
```

---

## 🔧 具体优化建议

### 1. 简化 RNAAgent 系统提示词

**当前问题：**
- 提示词包含太多工具说明
- 工作流规则过于详细
- 混合了路由逻辑

**优化后：**
```python
rna_expert = """
你是转录组分析专家。

【核心工作流】
1. 检查数据（inspect_file）
2. 推荐参数
3. 执行分析

【输出格式】
使用 <think> 标签包裹思考过程。

【当前上下文】
{{ context }}
"""
```

### 2. 工具说明移到代码层

**当前：** 工具说明在提示词中  
**优化：** 工具说明通过函数文档字符串和类型提示提供

```python
# 工具函数自带说明
def inspect_file(self, file_path: str) -> Dict[str, Any]:
    """
    检查数据文件，返回摘要信息。
    
    返回字段：
    - n_obs: 细胞数
    - n_vars: 基因数
    - is_normalized: 是否标准化
    """
    ...
```

### 3. RouterAgent 只做路由

**当前：** RouterAgent 可能包含分析逻辑  
**优化：** RouterAgent 只返回路由决策，不执行分析

```python
# RouterAgent 只返回：
{
    "routing": "rna_agent",
    "modality": "transcriptomics",
    "confidence": 0.95
}

# 具体分析由 RNAAgent 执行
```

### 4. 使用工具注册表

**当前：** 工具说明在提示词中  
**优化：** 使用工具注册表，动态生成工具说明

```python
# 工具注册表
TOOL_REGISTRY = {
    "inspect_file": {
        "description": "检查数据文件",
        "params": ["file_path"],
        "returns": ["n_obs", "n_vars", "is_normalized"]
    },
    ...
}

# 只在需要时注入到提示词
if need_tool_info:
    prompt += f"\n可用工具：{format_tools(TOOL_REGISTRY)}"
```

---

## 📊 架构对比

### 当前架构（复杂）

```
用户查询
  ↓
RouterAgent (复杂提示词 + 路由逻辑)
  ↓
RNAAgent (超长提示词 + 工具说明 + 工作流规则)
  ↓
执行分析
```

### 优化后架构（简洁）

```
用户查询
  ↓
RouterAgent (简单提示词，只做路由)
  ↓
RNAAgent (简洁提示词，只关注分析)
  ↓
执行分析
```

---

## ✅ 实施步骤

1. **简化 RouterAgent 提示词**
   - 移除分析相关说明
   - 只保留路由逻辑

2. **简化 RNAAgent 提示词**
   - 移除工具详细说明（移到代码层）
   - 简化工作流规则
   - 只保留核心职责

3. **工具说明代码化**
   - 使用函数文档字符串
   - 使用类型提示
   - 创建工具注册表

4. **动态提示词注入**
   - 根据上下文动态构建
   - 只注入必要信息

---

## 🎯 预期效果

1. **提示词更简洁**
   - RouterAgent: ~50 行 → ~20 行
   - RNAAgent: ~100 行 → ~30 行

2. **职责更清晰**
   - RouterAgent: 只做路由
   - RNAAgent: 只做分析

3. **模型处理更准确**
   - 减少混淆
   - 提高响应质量

4. **易于扩展**
   - 添加新智能体更容易
   - 工具说明统一管理

