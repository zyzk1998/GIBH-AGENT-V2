# GIBH-AGENT-V2 架构改动详细说明

## 📊 架构对比

### 🔵 **原始 V2 架构**（Docker 化之前）

```
用户浏览器
    ↓
直接访问 FastAPI 服务器 (端口 8018)
    ↓
server.py (单进程，同步执行)
    ├── 内嵌简单测试界面（左右分栏：对话 + 日志）
    ├── FastAPI 路由
    └── 直接调用智能体（同步）
```

**特点：**
- ✅ 简单直接，适合开发测试
- ✅ 单进程，易于调试
- ❌ 无法处理高并发
- ❌ 长时间任务会阻塞
- ❌ 前端界面简陋（内嵌在 server.py 中）

**启动方式：**
```bash
python server.py  # 或 uvicorn server:app --port 8018
```

---

### 🟢 **Docker 化后的架构**（当前）

```
用户浏览器
    ↓
NGINX 网关 (端口 8018，对外暴露)
    ├── / → 静态前端 (services/nginx/html/index.html)
    └── /api/* → 反向代理到 FastAPI
    ↓
FastAPI + Gunicorn (端口 8000，容器内部)
    ├── 2 个 Worker 进程
    ├── 同步请求 → 直接处理
    └── 异步任务 → 通过 Redis 发送到 Celery
    ↓
Celery Worker (容器内部)
    └── 处理长时间任务（通过 Redis 接收）
    ↓
Redis (端口 6379，容器内部)
    └── 消息队列 + 任务状态存储
```

**特点：**
- ✅ 微服务架构，易于扩展
- ✅ 支持异步任务处理
- ✅ 前端使用旧架构的精美界面
- ✅ 生产环境就绪
- ❌ 配置更复杂
- ❌ 需要 Docker 环境

**启动方式：**
```bash
sudo docker compose up -d --build
```

---

## 🔧 具体改动清单

### 1. **新增文件**

| 文件 | 说明 |
|------|------|
| `docker-compose.yml` | Docker Compose 编排文件，定义 4 个服务 |
| `services/api/Dockerfile` | API 服务器和 Worker 的镜像构建文件 |
| `services/nginx/conf.d/default.conf` | NGINX 反向代理配置 |
| `services/nginx/html/index.html` | 前端静态页面（从根目录复制） |
| `gibh_agent/core/celery_app.py` | Celery 应用配置 |
| `gibh_agent/core/tasks.py` | 异步任务定义（可选，当前未完全使用） |
| `.dockerignore` | Docker 构建忽略文件（排除大文件） |
| `docker-start.sh` | 一键启动脚本 |
| `docker-rebuild.sh` | 重新构建脚本 |

### 2. **修改文件**

| 文件 | 改动内容 |
|------|---------|
| `requirements.txt` | 新增：`celery`, `redis`, `gunicorn`, `paramiko` |
| `server.py` | 保持不变（仍可独立运行） |

### 3. **服务配置**

#### **NGINX 服务**（`gibh_v2_gateway`）
- **端口映射**：`8018:80`（对外暴露 8018）
- **功能**：
  - 静态文件服务（前端 HTML）
  - API 反向代理（`/api/*` → `http://api-server:8000`）
  - 静态资源服务（`/uploads/`, `/results/`）

#### **API 服务器**（`gibh_v2_api`）
- **内部端口**：8000（不对外暴露）
- **启动命令**：`gunicorn server:app -w 2 -k uvicorn.workers.UvicornWorker`
- **Worker 数量**：2 个进程
- **环境变量**：
  - `REDIS_URL=redis://redis:6379/0`
  - `SILICONFLOW_API_KEY`（从环境变量读取）
  - `SILICONFLOW_MODEL`（默认：`Pro/deepseek-ai/DeepSeek-V3.2`）

#### **Celery Worker**（`gibh_v2_worker`）
- **功能**：处理异步任务（当前配置了但未完全使用）
- **并发数**：4
- **依赖**：Redis

#### **Redis**（`gibh_v2_redis`）
- **端口**：6379（容器内部）
- **功能**：消息队列 + 任务状态存储

---

## 🌐 端口说明

| 服务 | 容器内部端口 | 对外暴露端口 | 说明 |
|------|------------|------------|------|
| NGINX | 80 | **8018** | 用户访问入口 |
| FastAPI | 8000 | - | 仅容器内部访问 |
| Redis | 6379 | - | 仅容器内部访问 |
| Celery | - | - | 无端口（通过 Redis 通信） |

**用户访问地址：**
- Web 界面：`http://localhost:8018`
- API 文档：`http://localhost:8018/api/docs`

---

## 📁 前端文件说明

### **问题：为什么界面和旧架构一样？**

**原因：**
1. NGINX 配置指向 `services/nginx/html/index.html`
2. 这个文件是从根目录的 `index.html` 复制过来的
3. 根目录的 `index.html` 是旧架构的精美界面（Kimi/Grok 风格）

**文件位置：**
- **根目录**：`/home/ubuntu/GIBH-AGENT-V2/index.html`（旧架构界面）
- **NGINX 使用**：`/home/ubuntu/GIBH-AGENT-V2/services/nginx/html/index.html`（已复制）
- **server.py 内嵌**：简单测试界面（左右分栏），仅在直接访问 API 服务器时显示

**如何切换前端？**
- 如果想用 `server.py` 的内嵌界面：修改 NGINX 配置，将 `/` 路由改为代理到 `http://api-server:8000/`
- 如果想用新界面：替换 `services/nginx/html/index.html` 文件

---

## ❌ 502 错误原因

**错误信息：** `502 Bad Gateway (nginx/1.29.4)`

**原因：**
1. **API 服务器启动失败**（缺少 `paramiko` 依赖）
   - `gibh_agent/core/dispatcher.py` 导入了 `paramiko`
   - `requirements.txt` 中缺少 `paramiko`
   - 容器启动时导入失败，Gunicorn Worker 无法启动

**已修复：**
- ✅ 已添加 `paramiko>=3.0.0` 到 `requirements.txt`

**下一步：**
```bash
# 重新构建并启动
sudo ./docker-rebuild.sh
sudo docker compose up -d
```

---

## 🔄 架构演进路线

### **阶段 1：原始 V2**（开发阶段）
- 单进程，同步执行
- 简单测试界面
- 适合快速开发和调试

### **阶段 2：Docker 化**（当前）
- 微服务架构
- 支持异步任务（Celery）
- 使用旧架构的精美前端
- 生产环境就绪

### **阶段 3：完全异步化**（可选）
- 所有长时间任务改为异步
- 添加任务状态查询 API
- 前端显示任务进度
- 集成 Flower 监控

---

## 📝 总结

**我做了什么：**
1. ✅ 将 V2 架构 Docker 化，采用微服务架构
2. ✅ 添加 NGINX 作为网关和反向代理
3. ✅ 配置 Celery + Redis 支持异步任务
4. ✅ 使用旧架构的精美前端界面
5. ✅ 优化 Docker 构建（国内镜像源、构建缓存）

**当前状态：**
- ✅ 架构已搭建完成
- ✅ 依赖已修复（paramiko）
- ⚠️ 需要重新构建 Docker 镜像才能启动

**访问方式：**
- 原始方式：`python server.py`（仍可用，端口 8018）
- Docker 方式：`http://localhost:8018`（通过 NGINX）

