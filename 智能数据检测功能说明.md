# 智能数据检测功能说明

## 🎯 功能概述

智能体现在可以**自动检测**用户是否上传了数据，如果没有，会**智能提示**用户选择本地测试数据集，无需手动输入文件路径。

---

## 🚀 使用场景

### 场景 1: 用户说要做 Cell Ranger 但没有上传数据

**用户输入：**
```
我要做单细胞转录组测序的第一步（Cell Ranger）
```

**智能体响应：**
```
检测到您没有上传相关数据。请选择：

1. 使用本地测试数据集
2. 上传您自己的数据

可用的测试数据集：

1. **PBMC 1k v3** (ID: pbmc_1k_v3)
   - 描述: 10x Genomics PBMC 1k cells v3 chemistry dataset
   - 细胞数: ~1,200
   - 化学版本: v3
   - FASTQ: /path/to/pbmc_1k_v3_fastqs/
   - 参考基因组: /path/to/refdata-gex-GRCh38-2024-A/
   - 已转换: /path/to/pbmc_1k_v3_filtered.h5ad

请选择数据集ID（例如：pbmc_1k_v3）或上传您的数据。
```

**用户选择：**
```
使用 pbmc_1k_v3
```

**智能体自动：**
1. 使用选定的测试数据
2. 运行 Cell Ranger count
3. 转换为 .h5ad
4. 执行完整分析流程
5. 返回可视化结果

---

### 场景 2: 用户上传了数据

**用户输入：**
```
分析这个数据
[上传文件: sample.h5ad]
```

**智能体响应：**
```
正在检查数据...
[自动执行 inspect_file]
[推荐参数]
[执行分析]
```

---

### 场景 3: 用户说要做全流程

**用户输入：**
```
执行单细胞转录组测序全流程
```

**智能体检测：**
- 关键词包含"全流程" → 需要 Cell Ranger
- 没有上传文件 → 提供测试数据选择

**智能体响应：**
```
检测到您要执行包含 Cell Ranger 的完整流程，但没有上传数据。

可用的测试数据集：
[显示数据集列表]

请选择数据集或上传您的数据。
```

---

## 🔧 技术实现

### 1. 测试数据管理器 (`TestDataManager`)

自动扫描 `test_data` 目录，检测可用的测试数据集：

```python
from gibh_agent.core.test_data_manager import TestDataManager

manager = TestDataManager()
datasets = manager.scan_test_datasets()
```

**检测逻辑：**
- 扫描 `test_data/` 目录
- 查找 FASTQ 目录（如 `pbmc_1k_v3_fastqs/`）
- 查找参考基因组（如 `refdata-gex-GRCh38-2024-A/`）
- 查找已转换的 .h5ad 文件
- 返回数据集信息

### 2. RNAAgent 智能检测

**检测流程：**
```python
1. 解析用户查询
2. 检测是否需要 Cell Ranger（关键词：cellranger, fastq, 第一步, 全流程等）
3. 检查是否有上传文件
4. 如果没有文件且需要 Cell Ranger：
   - 扫描测试数据集
   - 返回选择请求
5. 用户选择后，自动使用选定的数据
```

**关键词检测：**
- `cellranger`, `cell ranger`
- `fastq`, `fq`
- `第一步`, `全流程`, `完整流程`
- `从fastq`, `从测序`

### 3. 返回类型

**测试数据选择请求：**
```json
{
    "type": "test_data_selection",
    "message": "检测到您没有上传相关数据。请选择：",
    "options": ["1. 使用本地测试数据集", "2. 上传您自己的数据"],
    "datasets": [...],
    "datasets_json": "[JSON格式的数据集列表]",
    "datasets_display": "[格式化的显示文本]"
}
```

**用户选择后：**
```python
# 通过 kwargs 传递选择
result = await agent.process_query(
    query="使用 pbmc_1k_v3",
    test_dataset_id="pbmc_1k_v3"
)
```

---

## 📝 配置

在 `settings.yaml` 中配置测试数据目录：

```yaml
tools:
  test_data_dir: "${TEST_DATA_DIR:test_data}"
```

或通过环境变量：
```bash
export TEST_DATA_DIR=/path/to/test_data
```

---

## 🎨 前端集成建议

### 1. 检测返回类型

```javascript
if (response.type === "test_data_selection") {
    // 显示数据集选择界面
    showDatasetSelection(response.datasets);
}
```

### 2. 显示数据集列表

```javascript
function showDatasetSelection(datasets) {
    // 创建选择界面
    const container = document.createElement("div");
    datasets.forEach(dataset => {
        const button = document.createElement("button");
        button.textContent = dataset.name;
        button.onclick = () => selectDataset(dataset.id);
        container.appendChild(button);
    });
}
```

### 3. 用户选择后提交

```javascript
async function selectDataset(datasetId) {
    const response = await fetch("/api/query", {
        method: "POST",
        body: JSON.stringify({
            query: `使用 ${datasetId}`,
            test_dataset_id: datasetId
        })
    });
}
```

---

## ✅ 优势

1. **用户体验更好**：无需手动输入文件路径
2. **智能检测**：自动识别是否需要 Cell Ranger
3. **灵活选择**：可以选择测试数据或上传自己的数据
4. **自动化**：选择后自动执行完整流程
5. **可扩展**：易于添加新的测试数据集

---

## 🔮 未来扩展

1. **多数据集支持**：支持多个测试数据集
2. **数据集预览**：显示数据集的基本信息（细胞数、基因数等）
3. **数据集管理**：允许用户添加/删除测试数据集
4. **智能推荐**：根据用户需求推荐合适的数据集

---

## 📚 相关文档

- `使用测试数据的提示词示例.md` - 手动指定路径的方式（旧方式）
- `多智能体架构优化建议.md` - 架构设计说明
- `提示词优化总结.md` - 提示词简化说明

