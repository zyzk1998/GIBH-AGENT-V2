# ğŸš€ å¿«é€Ÿä¿®å¤ 502 é”™è¯¯

## ğŸ“‹ é—®é¢˜è¯Šæ–­ç»“æœ

ä»è¯Šæ–­æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š
- âŒ **API æœåŠ¡å™¨å®¹å™¨ä¸æ–­é‡å¯**ï¼š`Container ... is restarting`
- âŒ **NGINX æ— æ³•è¿æ¥ API æœåŠ¡å™¨**ï¼š`connect() failed (111: Connection refused)`
- âŒ **API æœåŠ¡å™¨å¯åŠ¨å¤±è´¥**

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1ï¼šä½¿ç”¨è‡ªåŠ¨ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
sudo ./fix-502.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. åœæ­¢æ‰€æœ‰å®¹å™¨
2. æ£€æŸ¥å¹¶æ·»åŠ ç¼ºå¤±çš„ä¾èµ–
3. é‡æ–°æ„å»ºé•œåƒ
4. å¯åŠ¨æœåŠ¡
5. éªŒè¯ä¿®å¤ç»“æœ

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨ä¿®å¤æ­¥éª¤

```bash
# 1. åœæ­¢æ‰€æœ‰å®¹å™¨
sudo docker compose down

# 2. ç¡®è®¤ requirements.txt åŒ…å« paramiko
grep paramiko requirements.txt
# åº”è¯¥çœ‹åˆ°ï¼šparamiko>=3.0.0

# 3. é‡æ–°æ„å»ºé•œåƒï¼ˆå¼ºåˆ¶é‡æ–°æ„å»ºï¼‰
sudo docker compose build --no-cache

# 4. å¯åŠ¨æœåŠ¡
sudo docker compose up -d

# 5. ç­‰å¾… 10 ç§’è®©æœåŠ¡å¯åŠ¨
sleep 10

# 6. æ£€æŸ¥å®¹å™¨çŠ¶æ€
sudo docker compose ps
# æ‰€æœ‰å®¹å™¨åº”è¯¥æ˜¯ "Up" çŠ¶æ€

# 7. æŸ¥çœ‹ API æœåŠ¡å™¨æ—¥å¿—
sudo docker compose logs api-server --tail 50
```

## ğŸ” éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
sudo docker compose ps
```

**é¢„æœŸè¾“å‡ºï¼š**
```
NAME                STATUS
gibh_v2_gateway     Up
gibh_v2_api         Up (healthy)
gibh_v2_worker      Up
gibh_v2_redis       Up
```

### 2. æ£€æŸ¥ API æœåŠ¡å™¨æ—¥å¿—

```bash
sudo docker compose logs api-server --tail 30
```

**ä¸åº”è¯¥çœ‹åˆ°ï¼š**
- âŒ `ModuleNotFoundError: No module named 'paramiko'`
- âŒ `Worker failed to boot`
- âŒ `ERROR: Worker (pid:X) exited with code 3`

**åº”è¯¥çœ‹åˆ°ï¼š**
- âœ… `âœ… GIBH-AGENT åˆå§‹åŒ–æˆåŠŸ`
- âœ… `ğŸš€ å¯åŠ¨æœåŠ¡å™¨ï¼Œç«¯å£: 8000`
- âœ… `Listening at: http://0.0.0.0:8000`

### 3. æµ‹è¯• API æœåŠ¡å™¨

```bash
# ä»å®¹å™¨å†…éƒ¨æµ‹è¯•
sudo docker compose exec api-server curl -s http://localhost:8000/api/docs | head -5

# ä»å¤–éƒ¨é€šè¿‡ NGINX æµ‹è¯•
curl -s http://localhost:8018/api/docs | head -5
```

### 4. è®¿é—®å‰ç«¯

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:8018`

**åº”è¯¥çœ‹åˆ°ï¼š**
- âœ… ç²¾ç¾çš„å‰ç«¯ç•Œé¢ï¼ˆä¸æ˜¯ 502 é”™è¯¯ï¼‰
- âœ… å¯ä»¥å‘é€æ¶ˆæ¯
- âœ… å¯ä»¥ä¸Šä¼ æ–‡ä»¶

## ğŸ› å¦‚æœä»ç„¶å¤±è´¥

### æŸ¥çœ‹å®Œæ•´é”™è¯¯æ—¥å¿—

```bash
# API æœåŠ¡å™¨å®Œæ•´æ—¥å¿—
sudo docker compose logs api-server > api-server-logs.txt 2>&1

# Worker å®Œæ•´æ—¥å¿—
sudo docker compose logs worker > worker-logs.txt 2>&1

# æ‰€æœ‰æœåŠ¡æ—¥å¿—
sudo docker compose logs > all-logs.txt 2>&1
```

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯ 1: `ModuleNotFoundError: No module named 'paramiko'`

**åŸå› ï¼š** é•œåƒæ„å»ºæ—¶æœªå®‰è£… paramiko

**è§£å†³ï¼š**
```bash
# ç¡®è®¤ requirements.txt åŒ…å« paramiko
grep paramiko requirements.txt

# å¼ºåˆ¶é‡æ–°æ„å»º
sudo docker compose build --no-cache api-server
sudo docker compose up -d api-server
```

#### é”™è¯¯ 2: `Worker failed to boot`

**åŸå› ï¼š** å¯èƒ½æ˜¯ä¾èµ–é—®é¢˜æˆ–é…ç½®é”™è¯¯

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo docker compose logs api-server | grep -A 20 "ERROR"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
sudo docker compose exec api-server env | grep -E "SILICONFLOW|REDIS"
```

#### é”™è¯¯ 3: `GIBH-AGENT åˆå§‹åŒ–å¤±è´¥`

**åŸå› ï¼š** é…ç½®æ–‡ä»¶æˆ– API Key é—®é¢˜

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat gibh_agent/config/settings.yaml

# æ£€æŸ¥ç¯å¢ƒå˜é‡
sudo docker compose exec api-server env | grep SILICONFLOW_API_KEY

# å¦‚æœæœªè®¾ç½®ï¼Œéœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡
export SILICONFLOW_API_KEY="your_api_key"
sudo docker compose up -d
```

#### é”™è¯¯ 4: å®¹å™¨ä¸æ–­é‡å¯

**åŸå› ï¼š** å¯åŠ¨å‘½ä»¤å¤±è´¥

**è§£å†³ï¼š**
```bash
# æŸ¥çœ‹å®Œæ•´å¯åŠ¨æ—¥å¿—
sudo docker compose logs api-server

# å°è¯•æ‰‹åŠ¨è¿›å…¥å®¹å™¨è°ƒè¯•
sudo docker compose run --rm api-server bash
# ç„¶ååœ¨å®¹å™¨å†…æ‰‹åŠ¨è¿è¡Œå¯åŠ¨å‘½ä»¤
```

## ğŸ“ ä¿®å¤åçš„æ¶æ„çŠ¶æ€

ä¿®å¤æˆåŠŸåï¼Œæ¶æ„åº”è¯¥æ˜¯ï¼š

```
âœ… NGINX (8018) â†’ âœ… FastAPI (8000) â†’ âœ… Celery Worker â†’ âœ… Redis
```

æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œ502 é”™è¯¯æ¶ˆå¤±ã€‚

## ğŸ†˜ å¦‚æœè¿˜æ˜¯æ— æ³•è§£å†³

1. **æ”¶é›†å®Œæ•´ä¿¡æ¯ï¼š**
   ```bash
   sudo docker compose ps > container-status.txt
   sudo docker compose logs > all-logs.txt 2>&1
   ```

2. **æ£€æŸ¥ç³»ç»Ÿèµ„æºï¼š**
   ```bash
   free -h
   df -h
   docker system df
   ```

3. **å°è¯•æœ€å°åŒ–æµ‹è¯•ï¼š**
   ```bash
   # åªå¯åŠ¨ API æœåŠ¡å™¨ï¼ˆä¸é€šè¿‡ NGINXï¼‰
   sudo docker compose up -d api-server
   sudo docker compose exec api-server curl http://localhost:8000/api/docs
   ```

