"""
Cell Ranger å·¥å…·
æ”¯æŒç”Ÿæˆè„šæœ¬å’Œæ‰§è¡Œ Cell Ranger åˆ†æ
"""
import os
import sys
import subprocess
import shutil
import logging
from typing import Dict, Any, List, Optional
from pathlib import Path

logger = logging.getLogger(__name__)


class CellRangerTool:
    """
    Cell Ranger å·¥å…·
    
    æ”¯æŒï¼š
    1. ç”Ÿæˆè„šæœ¬
    2. æ‰§è¡Œ Cell Ranger count
    3. æ£€æµ‹ FASTQ æ–‡ä»¶ç»“æ„
    """
    
    def __init__(self, config: Dict[str, Any] = None):
        """
        åˆå§‹åŒ– Cell Ranger å·¥å…·
        
        Args:
            config: é…ç½®å­—å…¸ï¼ŒåŒ…å« cellranger è·¯å¾„ã€å‚è€ƒåŸºå› ç»„ç­‰
        """
        self.config = config or {}
        # æ”¯æŒå®Œæ•´è·¯å¾„ï¼ˆå¦‚ /home/ubuntu/cellranger-10.0.0ï¼‰æˆ–ç›®å½•è·¯å¾„
        cellranger_path = self.config.get("path", "/opt/cellranger")
        if os.path.isfile(cellranger_path):
            # å¦‚æœæ˜¯æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ç›®å½•
            self.cellranger_path = os.path.dirname(cellranger_path)
        elif os.path.isdir(cellranger_path):
            # å¦‚æœæ˜¯ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ bin/cellranger
            if os.path.exists(os.path.join(cellranger_path, "bin", "cellranger")):
                self.cellranger_path = cellranger_path
            else:
                # å¯èƒ½æ˜¯æ—§ç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨ç›®å½•
                self.cellranger_path = cellranger_path
        else:
            # é»˜è®¤è·¯å¾„
            self.cellranger_path = cellranger_path
        
        self.cellranger_bin = os.path.join(self.cellranger_path, "bin", "cellranger")
        if not os.path.exists(self.cellranger_bin):
            # å°è¯•æ—§ç‰ˆæœ¬è·¯å¾„
            self.cellranger_bin = os.path.join(self.cellranger_path, "cellranger")
        
        self.reference = self.config.get("reference", "/data/refdata-cellranger-GRCh38-3.0.0")
    
    def generate_count_script(
        self,
        fastq_dir: str,
        sample_id: str,
        output_dir: str,
        reference: Optional[str] = None,
        localcores: int = 8,
        localmem: int = 64
    ) -> str:
        """
        ç”Ÿæˆ cellranger count è„šæœ¬
        
        Args:
            fastq_dir: FASTQ æ–‡ä»¶ç›®å½•è·¯å¾„
            sample_id: æ ·æœ¬ ID
            output_dir: è¾“å‡ºç›®å½•è·¯å¾„
            reference: å‚è€ƒåŸºå› ç»„è·¯å¾„ï¼ˆå¯é€‰ï¼‰
            localcores: æœ¬åœ°æ ¸å¿ƒæ•°
            localmem: æœ¬åœ°å†…å­˜ï¼ˆGBï¼‰
        
        Returns:
            Bash è„šæœ¬å†…å®¹
        """
        reference = reference or self.reference
        
        script = f"""#!/bin/bash
# Cell Ranger Count Script
# Generated by GIBH-Agent

set -e

# é…ç½®
CELLRANGER_PATH="{self.cellranger_path}"
REFERENCE="{reference}"
FASTQ_DIR="{fastq_dir}"
SAMPLE_ID="{sample_id}"
OUTPUT_DIR="{output_dir}"

# ç¯å¢ƒå˜é‡
export PATH=$CELLRANGER_PATH:$PATH

# æ‰§è¡Œ cellranger count
$CELLRANGER_PATH/cellranger count \\
    --id=$SAMPLE_ID \\
    --transcriptome=$REFERENCE \\
    --fastqs=$FASTQ_DIR \\
    --localcores={localcores} \\
    --localmem={localmem} \\
    --expect-cells=3000

# ç§»åŠ¨ç»“æœåˆ°è¾“å‡ºç›®å½•
if [ -d "$SAMPLE_ID/outs" ]; then
    mkdir -p $OUTPUT_DIR
    mv $SAMPLE_ID/outs/* $OUTPUT_DIR/
    echo "Cell Ranger count completed. Results in: $OUTPUT_DIR"
else
    echo "Error: Cell Ranger count failed"
    exit 1
fi
"""
        return script
    
    def generate_aggr_script(
        self,
        sample_dirs: List[str],
        sample_ids: List[str],
        output_dir: str,
        aggregation_csv: Optional[str] = None
    ) -> str:
        """
        ç”Ÿæˆ cellranger aggr è„šæœ¬ï¼ˆåˆå¹¶å¤šä¸ªæ ·æœ¬ï¼‰
        
        Args:
            sample_dirs: æ ·æœ¬ç›®å½•åˆ—è¡¨
            sample_ids: æ ·æœ¬ ID åˆ—è¡¨
            output_dir: è¾“å‡ºç›®å½•
            aggregation_csv: èšåˆ CSV æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
        
        Returns:
            Bash è„šæœ¬å†…å®¹
        """
        if aggregation_csv:
            csv_option = f"--csv={aggregation_csv}"
        else:
            # ç”Ÿæˆä¸´æ—¶ CSV
            csv_lines = ["library_id,molecule_h5"]
            for sid, sdir in zip(sample_ids, sample_dirs):
                csv_lines.append(f"{sid},{sdir}/molecule_info.h5")
            csv_content = "\\n".join(csv_lines)
            csv_option = f"--csv=<(echo -e \"{csv_content}\")"
        
        script = f"""#!/bin/bash
# Cell Ranger Aggr Script
# Generated by GIBH-Agent

set -e

CELLRANGER_PATH="{self.cellranger_path}"
OUTPUT_DIR="{output_dir}"

export PATH=$CELLRANGER_PATH:$PATH

# æ‰§è¡Œ cellranger aggr
$CELLRANGER_PATH/cellranger aggr \\
    --id=aggregated \\
    {csv_option}

# ç§»åŠ¨ç»“æœ
if [ -d "aggregated/outs" ]; then
    mkdir -p $OUTPUT_DIR
    mv aggregated/outs/* $OUTPUT_DIR/
    echo "Cell Ranger aggr completed. Results in: $OUTPUT_DIR"
else
    echo "Error: Cell Ranger aggr failed"
    exit 1
fi
"""
        return script
    
    def detect_fastq_structure(self, fastq_dir: str) -> Dict[str, Any]:
        """
        æ£€æµ‹ FASTQ æ–‡ä»¶ç»“æ„
        
        åªæ£€æŸ¥æ–‡ä»¶è·¯å¾„ï¼Œä¸è¯»å–æ–‡ä»¶å†…å®¹
        
        Args:
            fastq_dir: FASTQ ç›®å½•è·¯å¾„
        
        Returns:
            ç»“æ„ä¿¡æ¯å­—å…¸
        """
        fastq_path = Path(fastq_dir)
        
        if not fastq_path.exists():
            return {"error": "Directory does not exist"}
        
        # æŸ¥æ‰¾ FASTQ æ–‡ä»¶
        fastq_files = list(fastq_path.glob("*.fastq*"))
        
        # æ£€æµ‹ 10x ç»“æ„
        has_r1 = any("R1" in f.name or "_1" in f.name for f in fastq_files)
        has_r2 = any("R2" in f.name or "_2" in f.name for f in fastq_files)
        has_i1 = any("I1" in f.name or "_index" in f.name for f in fastq_files)
        
        return {
            "type": "10x" if (has_r1 and has_r2) else "standard",
            "num_files": len(fastq_files),
            "has_index": has_i1,
            "files": [str(f) for f in fastq_files[:10]]  # åªè¿”å›å‰10ä¸ªæ–‡ä»¶è·¯å¾„
        }
    
    def run_count(
        self,
        fastq_dir: str,
        sample_id: str,
        output_dir: str,
        reference: Optional[str] = None,
        sample: Optional[str] = None,
        localcores: int = 8,
        localmem: int = 32,
        create_bam: bool = False,
        expect_cells: Optional[int] = None
    ) -> Dict[str, Any]:
        """
        æ‰§è¡Œ cellranger count
        
        Args:
            fastq_dir: FASTQ æ–‡ä»¶ç›®å½•è·¯å¾„
            sample_id: æ ·æœ¬ IDï¼ˆä¹Ÿæ˜¯è¾“å‡ºç›®å½•åï¼‰
            output_dir: æœ€ç»ˆè¾“å‡ºç›®å½•è·¯å¾„
            reference: å‚è€ƒåŸºå› ç»„è·¯å¾„ï¼ˆå¯é€‰ï¼‰
            sample: æ ·æœ¬åç§°ï¼ˆä» FASTQ æ–‡ä»¶åæå–ï¼Œå¯é€‰ï¼‰
            localcores: æœ¬åœ°æ ¸å¿ƒæ•°
            localmem: æœ¬åœ°å†…å­˜ï¼ˆGBï¼‰
            create_bam: æ˜¯å¦åˆ›å»º BAM æ–‡ä»¶ï¼ˆCell Ranger 10.0.0+ å¿…éœ€å‚æ•°ï¼‰
            expect_cells: é¢„æœŸç»†èƒæ•°ï¼ˆå¯é€‰ï¼‰
        
        Returns:
            æ‰§è¡Œç»“æœå­—å…¸ï¼ŒåŒ…å«ï¼š
            - status: "success" æˆ– "error"
            - output_dir: è¾“å‡ºç›®å½•è·¯å¾„
            - matrix_dir: çŸ©é˜µç›®å½•è·¯å¾„ï¼ˆç”¨äºåç»­è½¬æ¢ï¼‰
            - error: é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
        """
        reference = reference or self.reference
        
        # å°†æ‰€æœ‰è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œé¿å…å·¥ä½œç›®å½•é—®é¢˜
        fastq_dir = os.path.abspath(fastq_dir)
        reference = os.path.abspath(reference)
        output_dir = os.path.abspath(output_dir)
        
        # æ£€æŸ¥ Cell Ranger æ˜¯å¦å­˜åœ¨
        if not os.path.exists(self.cellranger_bin):
            return {
                "status": "error",
                "error": f"Cell Ranger not found at: {self.cellranger_bin}",
                "output_dir": None,
                "matrix_dir": None
            }
        
        # æ£€æŸ¥ FASTQ ç›®å½•
        if not os.path.exists(fastq_dir):
            return {
                "status": "error",
                "error": f"FASTQ directory does not exist: {fastq_dir}",
                "output_dir": None,
                "matrix_dir": None
            }
        
        # æ£€æŸ¥å‚è€ƒåŸºå› ç»„
        if not os.path.exists(reference):
            return {
                "status": "error",
                "error": f"Reference genome does not exist: {reference}",
                "output_dir": None,
                "matrix_dir": None
            }
        
        # ç¡®å®šå·¥ä½œç›®å½•ï¼šCell Ranger ä¼šåœ¨å½“å‰ç›®å½•åˆ›å»º {sample_id} æ–‡ä»¶å¤¹
        # æˆ‘ä»¬éœ€è¦åœ¨è¾“å‡ºç›®å½•çš„çˆ¶ç›®å½•è¿è¡Œï¼Œè¿™æ · {sample_id} ä¼šåˆ›å»ºåœ¨æ­£ç¡®çš„ä½ç½®
        work_dir = os.path.dirname(output_dir) if os.path.dirname(output_dir) else os.getcwd()
        work_dir = os.path.abspath(work_dir)  # ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„
        
        # æ„å»ºå‘½ä»¤ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
        cmd = [
            self.cellranger_bin,
            "count",
            "--id", sample_id,
            "--create-bam", "true" if create_bam else "false",
            "--transcriptome", reference,
            "--fastqs", fastq_dir,
            "--localcores", str(localcores),
            "--localmem", str(localmem)
        ]
        
        # æ·»åŠ å¯é€‰å‚æ•°
        if sample:
            cmd.extend(["--sample", sample])
        if expect_cells:
            cmd.extend(["--expect-cells", str(expect_cells)])
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        env = os.environ.copy()
        env["PATH"] = f"{self.cellranger_path}/bin:{env.get('PATH', '')}"
        
        try:
            # æ‰§è¡Œå‘½ä»¤
            logger.info("ğŸš€ Running Cell Ranger count...")
            logger.info(f"   Command: {' '.join(cmd)}")
            logger.info(f"   Working directory: {work_dir}")
            print(f"ğŸš€ Running Cell Ranger count...")
            print(f"   Command: {' '.join(cmd)}")
            print(f"   Working directory: {work_dir}")
            sys.stdout.flush()
            
            # å®æ—¶è¾“å‡ºæ—¥å¿—ï¼šä½¿ç”¨ Popen è€Œä¸æ˜¯ runï¼Œä»¥ä¾¿å®æ—¶æ•è·è¾“å‡º
            process = subprocess.Popen(
                cmd,
                cwd=work_dir,
                env=env,
                stdout=subprocess.PIPE,
                stderr=subprocess.STDOUT,  # åˆå¹¶ stderr åˆ° stdout
                text=True,
                bufsize=1,  # è¡Œç¼“å†²
                universal_newlines=True
            )
            
            # å®æ—¶è¯»å–å¹¶è¾“å‡ºæ—¥å¿—
            stdout_lines = []
            
            # ä»è¿›ç¨‹å®æ—¶è¯»å–è¾“å‡º
            while True:
                output = process.stdout.readline()
                if output == '' and process.poll() is not None:
                    break
                if output:
                    line = output.strip()
                    if line:  # å¿½ç•¥ç©ºè¡Œ
                        stdout_lines.append(line)
                        # å®æ—¶è¾“å‡ºåˆ°ç»ˆç«¯å’Œæ—¥å¿—ç³»ç»Ÿ
                        log_msg = f"[Cell Ranger] {line}"
                        logger.info(log_msg)
                        print(f"   {log_msg}")
                        sys.stdout.flush()  # ç¡®ä¿ç«‹å³è¾“å‡º
            
            # ç­‰å¾…è¿›ç¨‹å®Œæˆ
            returncode = process.poll()
            
            # æ„å»ºå®Œæ•´çš„è¾“å‡º
            stdout = '\n'.join(stdout_lines)
            stderr = ''  # å·²åˆå¹¶åˆ° stdout
            
            # åˆ›å»ºç±»ä¼¼ subprocess.run çš„ç»“æœå¯¹è±¡
            class Result:
                def __init__(self, returncode, stdout, stderr):
                    self.returncode = returncode
                    self.stdout = stdout
                    self.stderr = stderr
            
            result = Result(returncode, stdout, stderr)
            
            # Cell Ranger ä¼šåœ¨ work_dir ä¸‹åˆ›å»º {sample_id} ç›®å½•
            output_path = os.path.join(work_dir, sample_id, "outs")
            matrix_dir = os.path.join(output_path, "filtered_feature_bc_matrix")
            
            if result.returncode == 0 and os.path.exists(matrix_dir):
                # Cell Ranger åœ¨ work_dir ä¸‹åˆ›å»ºäº† {sample_id} ç›®å½•
                # å¦‚æœæŒ‡å®šçš„ output_dir ä¸åˆ›å»ºçš„ä½ç½®ä¸åŒï¼Œéœ€è¦ç§»åŠ¨ç»“æœ
                cellranger_output = os.path.join(work_dir, sample_id)
                if os.path.abspath(output_dir) != os.path.abspath(cellranger_output):
                    # ç¡®ä¿ç›®æ ‡ç›®å½•çš„çˆ¶ç›®å½•å­˜åœ¨
                    os.makedirs(os.path.dirname(output_dir), exist_ok=True)
                    # å¦‚æœç›®æ ‡ç›®å½•å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
                    if os.path.exists(output_dir):
                        shutil.rmtree(output_dir)
                    # ç§»åŠ¨æ•´ä¸ª {sample_id} ç›®å½•åˆ° output_dir
                    shutil.move(cellranger_output, output_dir)
                    matrix_dir = os.path.join(output_dir, "outs", "filtered_feature_bc_matrix")
                else:
                    # å¦‚æœä½ç½®ç›¸åŒï¼Œç›´æ¥ä½¿ç”¨
                    matrix_dir = os.path.join(output_dir, "outs", "filtered_feature_bc_matrix")
                
                return {
                    "status": "success",
                    "output_dir": output_dir,
                    "matrix_dir": matrix_dir,
                    "stdout": result.stdout,
                    "stderr": result.stderr
                }
            else:
                # è¾“å‡ºé”™è¯¯ä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
                error_msg = f"Cell Ranger count failed with return code {result.returncode}"
                if result.stderr:
                    error_msg += f"\nSTDERR: {result.stderr[:500]}"  # åªæ˜¾ç¤ºå‰500å­—ç¬¦
                if result.stdout:
                    error_msg += f"\nSTDOUT: {result.stdout[:500]}"
                
                return {
                    "status": "error",
                    "error": error_msg,
                    "stdout": result.stdout,
                    "stderr": result.stderr,
                    "output_dir": None,
                    "matrix_dir": None
                }
        except Exception as e:
            return {
                "status": "error",
                "error": f"Exception while running Cell Ranger: {str(e)}",
                "output_dir": None,
                "matrix_dir": None
        }

