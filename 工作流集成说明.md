# å•ç»†èƒè½¬å½•ç»„æµ‹åºå…¨æµç¨‹ï¼ˆ11æ­¥ï¼‰é›†æˆè¯´æ˜

## âœ… æ˜¯çš„ï¼Œå·²é›†æˆåˆ°ä¸€ä¸ªæ™ºèƒ½ä½“ä¸­

### ğŸ“‹ é›†æˆæ¶æ„

**RNAAgentï¼ˆè½¬å½•ç»„æ™ºèƒ½ä½“ï¼‰** æ˜¯**å•ç»†èƒè½¬å½•ç»„æµ‹åºå…¨æµç¨‹çš„ä¸“å®¶æ™ºèƒ½ä½“**ï¼Œé›†æˆäº†å®Œæ•´çš„11æ­¥æµç¨‹ï¼š

```
RNAAgent (å•ç»†èƒè½¬å½•ç»„æµ‹åºå…¨æµç¨‹ä¸“å®¶æ™ºèƒ½ä½“)
â”œâ”€â”€ Cell Ranger å·¥å…· (æ­¥éª¤ 0)
â”œâ”€â”€ æ•°æ®æ£€æŸ¥å·¥å…· (æ­¥éª¤ 1)
â””â”€â”€ Scanpy åˆ†æå·¥å…· (æ­¥éª¤ 2-11)
    â”œâ”€â”€ QC (æ­¥éª¤ 2)
    â”œâ”€â”€ Normalization (æ­¥éª¤ 3)
    â”œâ”€â”€ HVG (æ­¥éª¤ 4)
    â”œâ”€â”€ Scale (æ­¥éª¤ 5)
    â”œâ”€â”€ PCA (æ­¥éª¤ 6)
    â”œâ”€â”€ Neighbors (æ­¥éª¤ 7)
    â”œâ”€â”€ Clustering (æ­¥éª¤ 8)
    â”œâ”€â”€ UMAP (æ­¥éª¤ 9)
    â”œâ”€â”€ t-SNE (æ­¥éª¤ 10)
    â””â”€â”€ Markers (æ­¥éª¤ 11)
```

## ğŸ” ä»£ç å®ç°ç»†èŠ‚

### 1. å·¥ä½œæµæ­¥éª¤å®šä¹‰

```python
# gibh_agent/agents/specialists/rna_agent.py

class RNAAgent(BaseAgent):
    def __init__(...):
        # æ ‡å‡†å·¥ä½œæµæ­¥éª¤ï¼ˆ10æ­¥ Scanpy æµç¨‹ï¼‰
        self.workflow_steps = [
            {"name": "1. Quality Control", "tool_id": "local_qc", ...},
            {"name": "2. Normalization", "tool_id": "local_normalize", ...},
            {"name": "3. Find Variable Genes", "tool_id": "local_hvg", ...},
            {"name": "4. Scale Data", "tool_id": "local_scale", ...},
            {"name": "5. PCA", "tool_id": "local_pca", ...},
            {"name": "6. Compute Neighbors", "tool_id": "local_neighbors", ...},
            {"name": "7. Clustering", "tool_id": "local_cluster", ...},
            {"name": "8. UMAP Visualization", "tool_id": "local_umap", ...},
            {"name": "9. t-SNE Visualization", "tool_id": "local_tsne", ...},
            {"name": "10. Find Markers", "tool_id": "local_markers", ...},
        ]
```

### 2. å®Œæ•´æµç¨‹æ‰§è¡Œ

```python
# gibh_agent/agents/specialists/rna_agent.py

async def execute_workflow(...):
    file_type = self.detect_file_type(input_path)
    
    if file_type == "fastq":
        # æ­¥éª¤ 0: Cell Ranger è®¡æ•°
        cellranger_result = self.scanpy_tool.run_cellranger(...)
        
        # è½¬æ¢ Cell Ranger è¾“å‡ºä¸º .h5ad
        convert_result = self.scanpy_tool.convert_cellranger_to_h5ad(...)
        
        # ä½¿ç”¨è½¬æ¢åçš„æ–‡ä»¶ç»§ç»­
        input_path = h5ad_path
    
    # æ­¥éª¤ 1-11: Scanpy åˆ†ææµç¨‹
    report = self.scanpy_tool.run_pipeline(
        data_input=input_path,
        steps_config=workflow_config.get("steps", [])
    )
```

### 3. å·¥å…·é›†æˆ

```python
# gibh_agent/tools/scanpy_tool.py

class ScanpyTool:
    def __init__(self, config, cellranger_tool=None):
        # å·¥å…·æ˜ å°„è¡¨ï¼šåŒ…å«æ‰€æœ‰11æ­¥çš„å·¥å…·
        self.tool_map = {
            "inspect_file": self.inspect_file,  # æ•°æ®æ£€æŸ¥
            "run_cellranger": self.run_cellranger,  # Cell Ranger
            "convert_cellranger_to_h5ad": self.convert_cellranger_to_h5ad,  # è½¬æ¢
            "local_qc": self.step_qc,  # æ­¥éª¤ 2
            "local_normalize": self.step_normalize,  # æ­¥éª¤ 3
            "local_hvg": self.step_hvg,  # æ­¥éª¤ 4
            "local_scale": self.step_scale,  # æ­¥éª¤ 5
            "local_pca": self.step_pca,  # æ­¥éª¤ 6
            "local_neighbors": self.step_neighbors,  # æ­¥éª¤ 7
            "local_cluster": self.step_cluster,  # æ­¥éª¤ 8
            "local_umap": self.step_umap,  # æ­¥éª¤ 9
            "local_tsne": self.step_tsne,  # æ­¥éª¤ 10
            "local_markers": self.step_markers  # æ­¥éª¤ 11
        }
```

## ğŸ“Š å®Œæ•´æµç¨‹æ‰§è¡Œè·¯å¾„

### ä» FASTQ å¼€å§‹ï¼ˆ12æ­¥ï¼‰ï¼š

```
ç”¨æˆ·è¾“å…¥: "åˆ†æ /data/fastqs/"
    â†“
1. RNAAgent.process_query() 
    â†“
2. RNAAgent.execute_workflow()
    â†“
3. æ£€æµ‹æ–‡ä»¶ç±»å‹ â†’ "fastq"
    â†“
4. æ­¥éª¤ 0: run_cellranger() â†’ Cell Ranger count
    â†“
5. è½¬æ¢: convert_cellranger_to_h5ad() â†’ .h5ad æ–‡ä»¶
    â†“
6. æ­¥éª¤ 1: inspect_file() â†’ æ•°æ®æ£€æŸ¥ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
    â†“
7. ScanpyTool.run_pipeline() â†’ æ‰§è¡Œæ­¥éª¤ 2-11
    â”œâ”€â”€ æ­¥éª¤ 2: step_qc()
    â”œâ”€â”€ æ­¥éª¤ 3: step_normalize()
    â”œâ”€â”€ æ­¥éª¤ 4: step_hvg()
    â”œâ”€â”€ æ­¥éª¤ 5: step_scale()
    â”œâ”€â”€ æ­¥éª¤ 6: step_pca()
    â”œâ”€â”€ æ­¥éª¤ 7: step_neighbors()
    â”œâ”€â”€ æ­¥éª¤ 8: step_cluster()
    â”œâ”€â”€ æ­¥éª¤ 9: step_umap()
    â”œâ”€â”€ æ­¥éª¤ 10: step_tsne()
    â””â”€â”€ æ­¥éª¤ 11: step_markers()
    â†“
8. è¿”å›å®Œæ•´åˆ†ææŠ¥å‘Š
```

### ä» .h5ad å¼€å§‹ï¼ˆ11æ­¥ï¼‰ï¼š

```
ç”¨æˆ·è¾“å…¥: "åˆ†æ /data/sample.h5ad"
    â†“
1. RNAAgent.process_query()
    â†“
2. è‡ªåŠ¨æ‰§è¡Œ inspect_file() â†’ æ­¥éª¤ 1
    â†“
3. RNAAgent.execute_workflow()
    â†“
4. æ£€æµ‹æ–‡ä»¶ç±»å‹ â†’ "h5ad"
    â†“
5. ScanpyTool.run_pipeline() â†’ ç›´æ¥æ‰§è¡Œæ­¥éª¤ 2-11
    â”œâ”€â”€ æ­¥éª¤ 2: step_qc()
    â”œâ”€â”€ æ­¥éª¤ 3: step_normalize()
    â”œâ”€â”€ ... (æ­¥éª¤ 3-11)
    â””â”€â”€ æ­¥éª¤ 11: step_markers()
    â†“
6. è¿”å›å®Œæ•´åˆ†ææŠ¥å‘Š
```

## ğŸ¯ å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. **ç»Ÿä¸€çš„æ™ºèƒ½ä½“æ¥å£**
- æ‰€æœ‰11æ­¥éƒ½é€šè¿‡ `RNAAgent` ä¸€ä¸ªæ¥å£è®¿é—®
- ç”¨æˆ·ä¸éœ€è¦çŸ¥é“åº•å±‚å·¥å…·ç»†èŠ‚

### 2. **è‡ªåŠ¨æµç¨‹ç¼–æ’**
- Agent è‡ªåŠ¨æ£€æµ‹è¾“å…¥ç±»å‹
- è‡ªåŠ¨å†³å®šæ˜¯å¦éœ€è¦ Cell Ranger
- è‡ªåŠ¨æ‰§è¡Œæ•°æ®æ£€æŸ¥å’Œå‚æ•°æ¨è

### 3. **æ¨¡å—åŒ–å·¥å…·è®¾è®¡**
- æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ç‹¬ç«‹çš„å·¥å…·æ–¹æ³•
- å¯ä»¥å•ç‹¬è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨
- å·¥å…·æ³¨å†Œåœ¨ `tool_map` ä¸­ï¼Œæ˜“äºæ‰©å±•

### 4. **æ™ºèƒ½å‚æ•°æ¨è**
- åŸºäºæ•°æ®æ£€æŸ¥ç»“æœè‡ªåŠ¨æ¨èå‚æ•°
- æ”¯æŒç”¨æˆ·ç¡®è®¤æˆ–ä¿®æ”¹å‚æ•°

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æµç¨‹ï¼ˆä» FASTQ å¼€å§‹ï¼‰ï¼š

```python
# ç”¨æˆ·äº¤äº’
query = "åˆ†æ /data/fastqs/ ç›®å½•ï¼Œå‚è€ƒåŸºå› ç»„åœ¨ /data/refdata/"

# Agent è‡ªåŠ¨æ‰§è¡Œï¼š
# 1. Cell Ranger count
# 2. è½¬æ¢ä¸º .h5ad
# 3. æ£€æŸ¥æ•°æ®
# 4. æ¨èå‚æ•°
# 5. æ‰§è¡Œå®Œæ•´ Scanpy æµç¨‹ï¼ˆ10æ­¥ï¼‰
result = await rna_agent.process_query(query, uploaded_files=[...])
```

### éƒ¨åˆ†æµç¨‹ï¼ˆä» .h5ad å¼€å§‹ï¼‰ï¼š

```python
# ç”¨æˆ·äº¤äº’
query = "åˆ†æ /data/sample.h5adï¼Œåªæ‰§è¡Œåˆ°èšç±»"

# Agent è‡ªåŠ¨æ‰§è¡Œï¼š
# 1. æ£€æŸ¥æ•°æ®
# 2. æ¨èå‚æ•°
# 3. æ‰§è¡Œ QC â†’ Normalization â†’ ... â†’ Clustering
result = await rna_agent.process_query(query, uploaded_files=[...])
```

## âœ… æ€»ç»“

**æ˜¯çš„ï¼Œæ•´ä¸ª11æ­¥æµç¨‹å·²å®Œå…¨é›†æˆåˆ° `RNAAgent`ï¼ˆå•ç»†èƒè½¬å½•ç»„æµ‹åºå…¨æµç¨‹ä¸“å®¶æ™ºèƒ½ä½“ï¼‰ä¸­ï¼š**

1. âœ… **æ­¥éª¤ 0**: Cell Ranger è®¡æ•°ï¼ˆé€šè¿‡ `run_cellranger`ï¼‰
2. âœ… **æ­¥éª¤ 1**: æ•°æ®æ£€æŸ¥ï¼ˆé€šè¿‡ `inspect_file`ï¼Œè‡ªåŠ¨æ‰§è¡Œï¼‰
3. âœ… **æ­¥éª¤ 2-11**: Scanpy åˆ†ææµç¨‹ï¼ˆé€šè¿‡ `run_pipeline`ï¼ŒåŒ…å«10ä¸ªæ­¥éª¤ï¼‰

**ç‰¹ç‚¹ï¼š**
- ç»Ÿä¸€çš„æ™ºèƒ½ä½“æ¥å£
- è‡ªåŠ¨æµç¨‹ç¼–æ’
- æ¨¡å—åŒ–å·¥å…·è®¾è®¡
- æ™ºèƒ½å‚æ•°æ¨è
- æ”¯æŒä» FASTQ æˆ– .h5ad å¼€å§‹

**ç”¨æˆ·åªéœ€ä¸ä¸€ä¸ªæ™ºèƒ½ä½“äº¤äº’ï¼Œå³å¯å®Œæˆæ•´ä¸ªå•ç»†èƒè½¬å½•ç»„æµ‹åºåˆ†ææµç¨‹ï¼**

